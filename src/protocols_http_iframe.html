<!DOCTYPE html>
<head>
	<meta charset="UTF-8">
	<script>
		var pendingPoll,
			pendingRequest,
			publicAddress = '{PUBLIC_ADDRESS}', // Added at runtime
			requests = 0,
			instanceId = -1,
			pendingEvents = [],
			pollFrequency = 2000,
			timeout = 60 * 1000,
			uuid = 'xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx'.replace(/x/g, function(c) {
				return (Math.floor(Math.random() * 16)).toString(16);
			});

		// From: http://stackoverflow.com/questions/901115/how-can-i-get-query-string-values-in-javascript
		function getParameterByName(name) {
			name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
			var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
			results = regex.exec(location.search);
			return results == null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
		}

		function send(type, d) {
			window.parent.postMessage(JSON.stringify({
				from: 'QuickIO',
				type: type,
				instanceId: instanceId,
				data: d
			}), '*');
		}

		function sendError() {
			send('error', null);
		}

		function poll(data, create) {
			var timeoutTimer,
				timedOut = false,
				request = new XMLHttpRequest(),
				url = '/?sid=' + uuid + (create ? '&connect=true' : '');

			request.open('POST', url, true);
			request.send(data || null);

			timeoutTimer = setTimeout(function() {
				timedOut = true;
				request.abort();
				sendError();
			}, timeout);

			request.onreadystatechange = function() {
				var i,
					events,
					evs = [];

				if (timedOut || request.readyState != 4) {
					return;
				}

				clearTimeout(timeoutTimer);
				timeoutTimer = null;

				if (request.status != 200) {
					sendError();
					return;
				}

				events = this.responseText.split('\n');
				for (i = 0; i < events.length; i++) {
					if (events[i]) {
						evs.push(events[i]);
					}
				}

				if (evs.length > 0) {
					send('events', evs);
				}

				if ((--requests) == 0) {
					requestPoll();
				}
			};

			pendingRequest = request;

			requests++;
		}

		function requestPoll() {
			if (!pendingPoll) {
				pendingPoll = setTimeout(function() {
					var evs = pendingEvents.join('\n');

					pendingEvents = [];
					poll(evs);

					pendingPoll = null;
				}, Math.ceil(Math.random() * pollFrequency));
			}
		}

		function onPostMessage(e) {
			var d = JSON.parse(e.data);

			if (d.from == 'QuickIO') {
				switch (d.type) {
					case 'event':
						pendingEvents.push(d.data);
						requestPoll();
						break;

					// Because IE8 rocks: it keeps connections going long
					// after the frame has been destroyed
					case 'close':
						if (pendingRequest && pendingRequest.readyState != 4) {
							pendingRequest.abort();
						}
						break;
				}
			}
		}

		function startClient() {
			if (window.addEventListener) {
				window.addEventListener('message', onPostMessage, false);
			} else if (window.attachEvent) {
				window.attachEvent('onmessage', onPostMessage);
			}

			poll('', true);

			send('ready', null);
		}

		function run() {
			if (document.addEventListener) {
				document.removeEventListener('DOMContentLoaded', run, false);
				window.removeEventListener('load', run, false);
			} else {
				document.detachEvent('onreadystatechange', run);
				window.detachEvent('onload', run);
			}

			instanceId = parseInt(getParameterByName('instanceId'));
			pollFrequency = parseInt(getParameterByName('pollFrequency')) || pollFrequency;
			timeout = parseInt(getParameterByName('timeout')) || timeout;

			if (window.location.hostname != publicAddress) {
				window.location.hostname = publicAddress;
			} else {
				startClient();
			}
		}

		if (document.addEventListener) {
			document.addEventListener('DOMContentLoaded', run, false);
			window.addEventListener('load', run, false);
		} else {
			document.attachEvent('onreadystatechange', run);
			window.attachEvent('onload', run);
		}
	</script>
</head>

<body>
</body>
