<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Writing Applications &mdash; QuickIO 0.2 documentation</title>
    
    <link rel="stylesheet" href="../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.2',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="QuickIO 0.2 documentation" href="../index.html" />
    <link rel="up" title="Overview of QuickIO" href="index.html" />
    <link rel="next" title="QuickIO Binaries" href="../binaries/index.html" />
    <link rel="prev" title="Client Architecture" href="client-architecture.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../binaries/index.html" title="QuickIO Binaries"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="client-architecture.html" title="Client Architecture"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">QuickIO 0.2 documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Overview of QuickIO</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="writing-applications">
<h1>Writing Applications<a class="headerlink" href="#writing-applications" title="Permalink to this headline">¶</a></h1>
<p>Applications are what <em>your</em> code runs in. An application should run in its own namespace and respect the internal namespace of the server. Applications may be written in any language that has C/C++ bindings.</p>
<div class="section" id="structure">
<h2>Structure<a class="headerlink" href="#structure" title="Permalink to this headline">¶</a></h2>
<p>Applications are responsible for running any internal threads they might need, maintaining any connections to external services, and not bringing the server down when they fail. Applications will receive only two general callbacks from the server during their typical lifetime, and a possible third callback when running unit tests.</p>
<div class="section" id="initialization">
<h3>Initialization<a class="headerlink" href="#initialization" title="Permalink to this headline">¶</a></h3>
<p>The first callback to the application will be right after it&#8217;s loaded into memory: it will be told to initialize itself. During this time, the application should listen for all events it&#8217;s interested in, setup any internal structures, and run any threads necessary to do its job. Should the application fail to initialize, it should inform the server by returning FALSE, indicating it failed.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Initialization is optional, but if you don&#8217;t implement it, you can&#8217;t really listen for events, and that&#8217;s rather pointless.</p>
</div>
</div>
<div class="section" id="exiting">
<h3>Exiting<a class="headerlink" href="#exiting" title="Permalink to this headline">¶</a></h3>
<p>The only other time the application will receive a general callback is when the server is exiting. At this point, the application MUST shut down its internal threads, close any external connections, and free any resources.</p>
</div>
</div>
<div class="section" id="registering-events">
<h2>Registering Events<a class="headerlink" href="#registering-events" title="Permalink to this headline">¶</a></h2>
<p>Since the server is built entirely around events, it might be useful to know to know how to register them. The call is incredibly simple:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="c1">// EV_PREFIX is usually defined as some namespace for your application, like: #define EV_PREFIX &quot;/my-app-prefix&quot;</span>
<span class="k">struct</span> <span class="n">event</span> <span class="o">*</span><span class="n">myev</span> <span class="o">=</span> <span class="n">evs_add_handler</span><span class="p">(</span><span class="n">EV_PREFIX</span><span class="p">,</span> <span class="s">&quot;/my-event&quot;</span><span class="p">,</span> <span class="n">_myev_handler</span><span class="p">,</span> <span class="n">_myev_on</span><span class="p">,</span> <span class="n">_myev_off</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">);</span>
</pre></div>
</div>
<p>This function returns an <cite>struct event</cite>, which is used to broadcast events to all clients subscribed to the event.</p>
<dl class="docutils">
<dt><cite>_myev_handler</cite></dt>
<dd>a function that will be called when the event is triggered from a client; if this is <cite>NULL</cite>, then it is assumed that no handler is wanted.</dd>
<dt><cite>_myev_on</cite></dt>
<dd>called when a client subscribes to an event. If this is NULL, it is assumed that any client will be allowed to subscribe. If it is a function, it may do any of the following:</dd>
</dl>
<ol class="arabic simple">
<li>Return EVS_STATUS_OK, indicating that the client should be subscribed immediately.</li>
<li>Return EVS_STATUS_HANDLED, indicating that no response should be sent back because verification of the event will be processed asynchronously, and a callback will be sent later.</li>
<li>Return EVS_STATUS_ERR, indicating that the client is not allowed to subscribe.</li>
</ol>
<div class="admonition important">
<p class="first admonition-title">Important</p>
<p class="last">This function MUST execute as fast as possible as it runs in one of the server&#8217;s main threads. Any background operations, long processing, socket operations, or anything that could potentially block should be done in another thread. Return EVS_STATUS_HANDLED for these operations, and schedule them to run in another thread.</p>
</div>
<dl class="docutils">
<dt><cite>_myev_off</cite></dt>
<dd>called when a client unsubscribes from an event. This is just a notification that the client left, and it cannot be stopped.</dd>
<dt><cite>handle_children</cite></dt>
<dd>a boolean value indicating if child events should also be handled by this event handler. If TRUE, the following events will all be handled by /my-app-prefix/my-event:</dd>
</dl>
<ul class="simple">
<li>/my-app-prefix/my-event</li>
<li>/my-app-prefix/my-event/some/child</li>
<li>/my-app-prefix/my-event/another/child</li>
</ul>
<p>It is completely up to the event handler if it wants to handle events with these path segments, and it may reject any event with segments it does not like. Extra event segments go to the handler and callbacks in a variable called <cite>ev_extra</cite>, or located inside <cite>struct evs_on_info</cite> as ev_extra.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">QuickIO reserves the <cite>/qio</cite> namespace for itself and its internal events. Applications MAY NEVER create events in this namespace.</p>
</div>
<div class="section" id="handling-events">
<h3>Handling Events<a class="headerlink" href="#handling-events" title="Permalink to this headline">¶</a></h3>
<p>When a client sends an event to the server, it is routed to the registered handler. The handler callback looks like:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="k">typedef</span> <span class="k">enum</span> <span class="nf">evs_status</span> <span class="p">(</span><span class="o">*</span><span class="n">evs_handler_fn</span><span class="p">)(</span>
        <span class="k">struct</span> <span class="n">client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
        <span class="k">const</span> <span class="n">gchar</span> <span class="o">*</span><span class="n">ev_extra</span><span class="p">,</span>
        <span class="k">const</span> <span class="kt">evs_cb_t</span> <span class="n">client_cb</span><span class="p">,</span>
        <span class="n">gchar</span> <span class="o">*</span><span class="n">json</span><span class="p">);</span>
</pre></div>
</div>
<p>This function is expected to return a status, as described above, and is given the following:</p>
<ol class="arabic simple">
<li>client: The client that sent the event</li>
<li>ev_extra: Any extra path segments sent from the client</li>
<li>client_cb: Where any callback from the event should be sent</li>
<li>json: A JSON string of data from the client. Check out <a class="reference external" href="../doxygen/json_8h.html">qev_json</a> for reading it.</li>
</ol>
</div>
</div>
<div class="section" id="sending-callbacks">
<h2>Sending Callbacks<a class="headerlink" href="#sending-callbacks" title="Permalink to this headline">¶</a></h2>
<p>So what if you have an event subscription callback that does asynchronous verification of events, and you want to send the proper callbacks? There are a set of callback functions to help you out here.</p>
<div class="highlight-c"><div class="highlight"><pre><span class="n">evs_on_cb</span><span class="p">()</span>
<span class="n">evs_on_info_copy</span><span class="p">()</span>
<span class="n">evs_on_info_free</span><span class="p">()</span>
</pre></div>
</div>
<p><a class="reference external" href="../doxygen/evs_8h.html">Check them out</a>.</p>
</div>
<div class="section" id="creating-server-callbacks">
<h2>Creating Server Callbacks<a class="headerlink" href="#creating-server-callbacks" title="Permalink to this headline">¶</a></h2>
<p>Client callbacks are simple enough to understand, but what about when you want to be able to have a callback on the server? The easiest way to see these is to look at some code:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="c1">// Whatever data needs to be passed to callback handler</span>
<span class="k">struct</span> <span class="n">callback_data</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">id</span><span class="p">;</span>
        <span class="n">gchar</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
        <span class="kt">float</span> <span class="n">percent</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">status</span> <span class="nf">_callback</span><span class="p">(</span>
        <span class="k">struct</span> <span class="n">client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
        <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
        <span class="k">const</span> <span class="kt">evs_cb_t</span> <span class="n">client_cb</span><span class="p">,</span>
        <span class="n">gchar</span> <span class="o">*</span><span class="n">json</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">return</span> <span class="n">CLIENT_GOOD</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">_free</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">struct</span> <span class="n">callback_data</span> <span class="o">*</span><span class="n">d</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
        <span class="n">g_free</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
        <span class="n">g_slice_free1</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">d</span><span class="p">),</span> <span class="n">d</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">evs_status</span> <span class="nf">_handler</span><span class="p">(</span>
        <span class="k">struct</span> <span class="n">client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
        <span class="k">const</span> <span class="n">gchar</span> <span class="o">*</span><span class="n">ev_extra</span> <span class="n">G_GNUC_UNUSED</span><span class="p">,</span>
        <span class="k">const</span> <span class="kt">evs_cb_t</span> <span class="n">client_cb</span><span class="p">,</span>
        <span class="n">gchar</span> <span class="o">*</span><span class="n">json</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">struct</span> <span class="n">callback_data</span> <span class="o">*</span><span class="n">d</span> <span class="o">=</span> <span class="n">g_slice_alloc0</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">d</span><span class="p">));</span>
        <span class="n">d</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">g_strdup</span><span class="p">(</span><span class="s">&quot;test&quot;</span><span class="p">);</span>

        <span class="n">evs_cb_with_cb</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">client_cb</span><span class="p">,</span> <span class="n">json</span><span class="p">,</span> <span class="n">_callback</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">_free</span><span class="p">);</span>

        <span class="k">return</span> <span class="n">EVS_STATS_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">...</span> <span class="n">snip</span> <span class="p">...</span>

<span class="n">evs_add_handler</span><span class="p">(</span><span class="n">EV_PREFIX</span><span class="p">,</span> <span class="s">&quot;/event&quot;</span><span class="p">,</span> <span class="n">_hander</span><span class="p">,</span> <span class="n">evs_no_on</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">);</span>

<span class="p">...</span> <span class="n">snip</span> <span class="p">...</span>
</pre></div>
</div>
<p>The event flow will be as follows:</p>
<ol class="arabic simple">
<li>An event comes in and is sent to _handler()</li>
<li>Handler sends a callback to the client, passing it the function to be called, the data to be given to the function, and a free function. The ownership of the data passes to QuickIO, and it will free it as necessary.</li>
<li>The client receives the event and triggers the server callback</li>
<li>The _callback() function is called, and it responds exactly like _handler does</li>
<li>Once _callback() is done, the data is free&#8217;d</li>
</ol>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">A server callback might <em>never</em> be called: a client has a limited number of server callbacks it can have registered simultaneously, so if it exceeds the number its allowed, then old callbacks will be culled to make room for the new. Chances are this will never happen, but it is a possibility.</p>
</div>
</div>
<div class="section" id="example">
<h2>Example<a class="headerlink" href="#example" title="Permalink to this headline">¶</a></h2>
<p>In this example, we (fakely) track the population of the world, sending out an updated population event every time a baby is born.</p>
<p>You&#8217;ll probably want to check out the <a class="reference external" href="../doxygen">Doxygen API docs just to see what is possible</a></p>
<div class="section" id="code">
<h3>Code<a class="headerlink" href="#code" title="Permalink to this headline">¶</a></h3>
<p>Enough talk, let&#8217;s see what we can do here!</p>
<div class="highlight-c"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185</pre></div></td><td class="code"><div class="highlight"><pre><span class="c1">// This file includes everything you need to write an app for QuickIO</span>
<span class="cp">#include &quot;quickio.h&quot;</span>

<span class="cm">/**</span>
<span class="cm"> * All events in this application are prefixed to /skeleton</span>
<span class="cm"> */</span>
<span class="cp">#define EV_PREFIX &quot;/skeleton&quot;</span>

<span class="cm">/**</span>
<span class="cm"> * The structure representing the events in the queue.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">pending</span> <span class="p">{</span>
	<span class="cm">/**</span>
<span class="cm">	 * The number of babies born in this event.</span>
<span class="cm">	 */</span>
	<span class="n">gint64</span> <span class="n">babies_born</span><span class="p">;</span>

	<span class="cm">/**</span>
<span class="cm">	 * A reference to the client, for the callback</span>
<span class="cm">	 */</span>
	<span class="k">struct</span> <span class="n">client</span> <span class="o">*</span><span class="n">client</span><span class="p">;</span>

	<span class="cm">/**</span>
<span class="cm">	 * For if we want to send a callback</span>
<span class="cm">	 */</span>
	<span class="kt">evs_cb_t</span> <span class="n">client_cb</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * The thread for running all async tasks; will be joined on exit.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">GThread</span> <span class="o">*</span><span class="n">_thread</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * Where all events are sent for processing; in this application, it&#39;s not</span>
<span class="cm"> * really necessary as we&#39;re just processing integer increments, but it&#39;s</span>
<span class="cm"> * a good way to show how to do things asynchronously.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">GAsyncQueue</span> <span class="o">*</span><span class="n">_events</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * The handler for population events</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">event</span> <span class="o">*</span><span class="n">_ev_population</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * The population of the earth, as is known right now. This value is only</span>
<span class="cm"> * ever updated inside the skeleton thread.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">gint64</span> <span class="n">_population</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * If you need external configuration for an app, it&#39;s already provided for you.</span>
<span class="cm"> * Check out quick-event&#39;s config documentation for all options.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">qev_cfg</span> <span class="n">_cfg</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;population&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">description</span> <span class="o">=</span> <span class="s">&quot;How many people there are on earth&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">QEV_CFG_INT64</span><span class="p">,</span>
		<span class="p">.</span><span class="n">val</span><span class="p">.</span><span class="n">i64</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">_population</span><span class="p">,</span>
		<span class="p">.</span><span class="n">defval</span><span class="p">.</span><span class="n">i64</span> <span class="o">=</span> <span class="mi">7000000000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">validate</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">read_only</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">evs_status</span> <span class="nf">_ev_baby_born_handler</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
	<span class="k">const</span> <span class="n">gchar</span> <span class="o">*</span><span class="n">ev_extra</span> <span class="n">G_GNUC_UNUSED</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">evs_cb_t</span> <span class="n">client_cb</span><span class="p">,</span>
	<span class="n">gchar</span> <span class="o">*</span><span class="n">json</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pending</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="n">gint64</span> <span class="n">babies_born</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">qev_json_status</span> <span class="n">status</span><span class="p">;</span>

	<span class="c1">// This will modify the contents of `json`</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">qev_json_unpack</span><span class="p">(</span><span class="n">json</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">babies_born</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">QEV_JSON_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">evs_err_cb</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">client_cb</span><span class="p">,</span> <span class="n">CODE_BAD</span><span class="p">,</span> <span class="s">&quot;could not parse JSON&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">babies_born</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="c1">// Should probably give a better error message here</span>
		<span class="n">evs_err_cb</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">client_cb</span><span class="p">,</span> <span class="n">CODE_BAD</span><span class="p">,</span> <span class="s">&quot;invalid number of babies born&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">g_slice_alloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">));</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">babies_born</span> <span class="o">=</span> <span class="n">babies_born</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">client</span> <span class="o">=</span> <span class="n">qev_ref</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">client_cb</span> <span class="o">=</span> <span class="n">client_cb</span><span class="p">;</span>

	<span class="n">g_async_queue_push</span><span class="p">(</span><span class="n">_events</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">EVS_STATUS_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span><span class="o">*</span> <span class="nf">_run</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">nothing</span> <span class="n">G_GNUC_UNUSED</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">GString</span> <span class="o">*</span><span class="n">buff</span> <span class="o">=</span> <span class="n">qev_buffer_get</span><span class="p">();</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">pending</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">g_async_queue_pop</span><span class="p">(</span><span class="n">_events</span><span class="p">);</span>

		<span class="c1">// Once we get a NULL, assume we&#39;re exiting. The server finishes all</span>
		<span class="c1">// events before calling exit, so no more events will ever be in the</span>
		<span class="c1">// queue.</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">_population</span> <span class="o">+=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">babies_born</span><span class="p">;</span>

		<span class="c1">// Send the client a callback asynchronously.</span>
		<span class="n">evs_cb</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">client_cb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">qev_unref</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">);</span>
		<span class="n">g_slice_free1</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">),</span> <span class="n">p</span><span class="p">);</span>

		<span class="c1">// Broadcast the new world population to everyone</span>
		<span class="n">qev_buffer_clear</span><span class="p">(</span><span class="n">buff</span><span class="p">);</span>
		<span class="n">qev_json_pack</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">_population</span><span class="p">);</span>
		<span class="n">evs_broadcast</span><span class="p">(</span><span class="n">_ev_population</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">buff</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">qev_buffer_put</span><span class="p">(</span><span class="n">buff</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">gboolean</span> <span class="nf">_app_init</span><span class="p">()</span>
<span class="p">{</span>
	<span class="c1">// Read any configuration values set straight into our variables</span>
	<span class="n">qev_cfg_add</span><span class="p">(</span><span class="s">&quot;skeleton&quot;</span><span class="p">,</span> <span class="n">_cfg</span><span class="p">,</span> <span class="n">G_N_ELEMENTS</span><span class="p">(</span><span class="n">_cfg</span><span class="p">));</span>

	<span class="n">_events</span> <span class="o">=</span> <span class="n">g_async_queue_new</span><span class="p">();</span>
	<span class="n">_thread</span> <span class="o">=</span> <span class="n">g_thread_new</span><span class="p">(</span><span class="s">&quot;skeleton&quot;</span><span class="p">,</span> <span class="n">_run</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="c1">// Will be automatically configured with the rest of quick-event&#39;s</span>
	<span class="c1">// configuration loading</span>
	<span class="n">qev_cfg_add</span><span class="p">(</span><span class="s">&quot;skeleton&quot;</span><span class="p">,</span> <span class="n">_cfg</span><span class="p">,</span> <span class="n">G_N_ELEMENTS</span><span class="p">(</span><span class="n">_cfg</span><span class="p">));</span>

	<span class="c1">// No one may subscribe to this event</span>
	<span class="n">evs_add_handler</span><span class="p">(</span><span class="n">EV_PREFIX</span><span class="p">,</span> <span class="s">&quot;/baby-born&quot;</span><span class="p">,</span>
		<span class="n">_ev_baby_born_handler</span><span class="p">,</span> <span class="n">evs_no_on</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">);</span>

	<span class="c1">// Anyone may subscribe to this event</span>
	<span class="n">_ev_population</span> <span class="o">=</span> <span class="n">evs_add_handler</span><span class="p">(</span><span class="n">EV_PREFIX</span><span class="p">,</span> <span class="s">&quot;/population&quot;</span><span class="p">,</span>
		<span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">gboolean</span> <span class="nf">_app_exit</span><span class="p">()</span>
<span class="p">{</span>
	<span class="n">g_async_queue_push</span><span class="p">(</span><span class="n">_events</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">g_thread_join</span><span class="p">(</span><span class="n">_thread</span><span class="p">);</span>
	<span class="n">_thread</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">g_async_queue_unref</span><span class="p">(</span><span class="n">_events</span><span class="p">);</span>
	<span class="n">_events</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">gboolean</span> <span class="nf">_app_test</span><span class="p">()</span>
<span class="p">{</span>
	<span class="c1">// Used to run test cases on the application</span>
	<span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Use this macro so that when the server loads the app, it knows what to call.</span>
<span class="cm"> */</span>
<span class="n">QUICKIO_APP</span><span class="p">(</span>
	<span class="n">_app_init</span><span class="p">,</span>
	<span class="n">_app_exit</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * If you implement test cases, you&#39;re also going to need this macro.</span>
<span class="cm"> */</span>
<span class="n">QUICKIO_APP_TEST</span><span class="p">(</span><span class="n">_app_test</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Writing Applications</a><ul>
<li><a class="reference internal" href="#structure">Structure</a><ul>
<li><a class="reference internal" href="#initialization">Initialization</a></li>
<li><a class="reference internal" href="#exiting">Exiting</a></li>
</ul>
</li>
<li><a class="reference internal" href="#registering-events">Registering Events</a><ul>
<li><a class="reference internal" href="#handling-events">Handling Events</a></li>
</ul>
</li>
<li><a class="reference internal" href="#sending-callbacks">Sending Callbacks</a></li>
<li><a class="reference internal" href="#creating-server-callbacks">Creating Server Callbacks</a></li>
<li><a class="reference internal" href="#example">Example</a><ul>
<li><a class="reference internal" href="#code">Code</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="client-architecture.html"
                        title="previous chapter">Client Architecture</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../binaries/index.html"
                        title="next chapter">QuickIO Binaries</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/overview/writing-applications.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../binaries/index.html" title="QuickIO Binaries"
             >next</a> |</li>
        <li class="right" >
          <a href="client-architecture.html" title="Client Architecture"
             >previous</a> |</li>
        <li><a href="../index.html">QuickIO 0.2 documentation</a> &raquo;</li>
          <li><a href="index.html" >Overview of QuickIO</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012-2014 Clear Channel Inc. Released under the MIT License..
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
  </body>
</html>